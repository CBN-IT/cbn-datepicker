<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../datetime-picker/overlay-date-picker.html">
<link rel="import" href="../paper-input/paper-input-container.html">

<script type="text/javascript" src="../moment/min/moment.min.js"></script>
<dom-module id="cbn-datepicker">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
      <paper-input-container always-float-label attr-for-value="value">
          <label slot="label">{{label}}</label>
          <overlay-date-picker id="datePicker" slot="input" auto-confirm class="paper-input-input" value="{{timestamp}}" native="{{native}}" vertical-align="auto" horizontal-align="auto" ></overlay-date-picker>
      </paper-input-container>
  </template>

  <script>
      class CbnDatepicker extends Polymer.Element {
          static get is() {
              return 'cbn-datepicker';
          }

          static get properties() {
              return {
                  timestamp: {
                      type: Number,
                      observer: "changedTimeStamp"
                  },
                  name: {
                      type: String
                  },
                  label: {
                      type: String
                  },
                  value: {
                      type: String,
                      observer: "changedValue",
                      notify: true
                  },
                  defaultValue: {
                      type: String,
                      observer: "changedDefaultValue"
                  },
                  minDate: {
                      type: String
                  },
                  maxDate: {
                      type: String
                  },

                  native: {
                      type: Boolean,
                      value: function () {
                          const ua = window.navigator.userAgent;
                          return (/[mM]obi/i.test(ua) || /[tT]ablet/i.test(ua) || /[aA]ndroid/i.test(ua));
                      }
                  }
              };
          }

          static get observers() {
              return [
                  'changedMinMax(minDate,"min")',
                  'changedMinMax(maxDate, "max")'
              ]
          }

          changedMinMax(variable, name){
              this.$.datePicker[name] = this.parseDate(variable).format();
          }

          changedTimeStamp() {
              this.value = moment(this.timestamp).format("YYYY-MM-DD");
          }

          changedValue() {
              let formatedValue = this.parseDate(this.value).format("YYYY-MM-DD");
              if(this.value !== formatedValue){
                    this.value = formatedValue;
                    return;
              }
              if (moment(this.timestamp).format("YYYY-MM-DD") !== this.value) {
                  this.timestamp = new moment(this.value).valueOf();
                  // this.$.datePicker.confirm();
              }
          }

          changedDefaultValue() {
              // this.timestamp = this.parseDate(this.defaultValue).valueOf();
              // this.$.datePicker.confirm();
          }

          parseDate(dateStr, format, referenceDate) {
              let date = null;
              if (dateStr != null) {
                  if (typeof dateStr === "string") {
                      let shortands = {
                          'm': 'months',
                          'd': 'days',
                          'y': 'years'
                      };
                      let pattern = /([+=-])([+-]?[0-9]+)\s*([a-z]+)/ig;
                      let matches = pattern.exec(dateStr);
                      if (matches) { // it's a relative date
                          if (!referenceDate) referenceDate = moment();
                          date = moment(referenceDate).startOf("day");
                          while (matches) {
                              let op = matches[1];
                              let value = parseInt(matches[2], 10);
                              let name = matches[3];
                              if (shortands.hasOwnProperty(name.toLowerCase())) {
                                  name = shortands[name.toLowerCase()];
                              }
                              switch (op) {
                                  case '+':
                                      date.add(value, name);
                                      break;
                                  case '-':
                                      date.subtract(value, name);
                                      break;
                                  case '=':
                                      if (name == 'days') {
                                          name = 'date';
                                      }
                                      date.set(name, value);
                                      break;
                              }
                              matches = pattern.exec(dateStr);
                          }

                      } else {
                          if (format === 'moment') {
                              // invalid value, should have been a Moment object
                              return null;
                          }
                          date = moment(dateStr, format);
                      }
                  } else {
                      date = moment(dateStr);
                  }
              }
              if (date && !date.isValid())
                  date = null;
              return date;
          }


      }

      window.customElements.define(CbnDatepicker.is, CbnDatepicker);
  </script>
</dom-module>
